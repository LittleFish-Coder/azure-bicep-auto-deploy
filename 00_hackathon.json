{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.36.177.2456",
      "templateHash": "13956664462267611824"
    }
  },
  "parameters": {
    "team": {
      "type": "string",
      "defaultValue": "00"
    },
    "userIds": {
      "type": "array",
      "defaultValue": []
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[format('rg-hackathon-team{0}', parameters('team'))]"
    },
    "aiFoundryName": {
      "type": "string",
      "defaultValue": "[format('ai-foundry-hackathon-team{0}', parameters('team'))]"
    },
    "aiProjectName": {
      "type": "string",
      "defaultValue": "[format('ai-project-hackathon-team{0}', parameters('team'))]"
    },
    "aiSearchName": {
      "type": "string",
      "defaultValue": "[format('ai-search-hackathon-team{0}', parameters('team'))]"
    },
    "openAIName": {
      "type": "string",
      "defaultValue": "[format('openai-hackathon-team{0}', parameters('team'))]"
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "[format('storagehackathonteam{0}', parameters('team'))]"
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2025-04-01",
      "name": "[parameters('resourceGroupName')]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "aiFoundryModule",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiFoundryName": {
            "value": "[parameters('aiFoundryName')]"
          },
          "aiProjectName": {
            "value": "[parameters('aiProjectName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "14445490889187816486"
            }
          },
          "parameters": {
            "aiFoundryName": {
              "type": "string"
            },
            "aiProjectName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-04-01-preview",
              "name": "[parameters('aiFoundryName')]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "sku": {
                "name": "S0"
              },
              "kind": "AIServices",
              "properties": {
                "allowProjectManagement": true,
                "customSubDomainName": "[parameters('aiFoundryName')]",
                "disableLocalAuth": true
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/projects",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}', parameters('aiFoundryName'), parameters('aiProjectName'))]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {},
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "aiSearchModule",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiSearchName": {
            "value": "[parameters('aiSearchName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "12907395267988208681"
            }
          },
          "parameters": {
            "aiSearchName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2025-02-01-preview",
              "name": "[parameters('aiSearchName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "standard"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "partitionCount": 1,
                "replicaCount": 1,
                "hostingMode": "default",
                "authOptions": {
                  "aadOrApiKey": {
                    "aadAuthFailureMode": "http401WithBearerChallenge"
                  }
                },
                "disableLocalAuth": false
              }
            }
          ],
          "outputs": {
            "aiSearchPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), '2025-02-01-preview', 'full').identity.principalId]"
            },
            "aiSearchName": {
              "type": "string",
              "value": "[parameters('aiSearchName')]"
            },
            "aiSearchId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Search/searchServices', parameters('aiSearchName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "storageModule",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[parameters('storageAccountName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "1792338530753452918"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2025-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot"
              }
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            },
            "storageAccountName": {
              "type": "string",
              "value": "[parameters('storageAccountName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "openAIModule",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "openAIName": {
            "value": "[parameters('openAIName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "1312251598633197449"
            }
          },
          "parameters": {
            "openAIName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-06-01",
              "name": "[parameters('openAIName')]",
              "location": "[parameters('location')]",
              "kind": "OpenAI",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "customSubDomainName": "[parameters('openAIName')]",
                "publicNetworkAccess": "Enabled"
              }
            }
          ],
          "outputs": {
            "openAIId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName'))]"
            },
            "openAIEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), '2025-06-01').endpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "rbacModule",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "userIds": {
            "value": "[parameters('userIds')]"
          },
          "aiSearchPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'aiSearchModule'), '2022-09-01').outputs.aiSearchPrincipalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "13374804469229652678"
            }
          },
          "parameters": {
            "userIds": {
              "type": "array"
            },
            "aiSearchPrincipalId": {
              "type": "string"
            }
          },
          "variables": {
            "roleDefinitions": {
              "userGroupOwner": "8e3af657-a8ff-443c-a75c-2fe8c4bcb635",
              "userGroupContributor": "b24988ac-6180-42a0-ab88-20f7382dd24c",
              "searchServiceContributor": "7ca78c08-252a-4471-8644-bb5ff32d4ba0",
              "searchIndexDataContributor": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
              "searchIndexDataReader": "1407120a-92aa-4202-b7e9-c0e197c71c8f",
              "storageBlobDataReader": "2a2b9908-6ea1-4ae2-8e65-a410df84e7d1",
              "cognitiveServicesOpenAIUser": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('aiSearchPrincipalId'), 'StorageBlobDataReader')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').storageBlobDataReader)]",
                "principalId": "[parameters('aiSearchPrincipalId')]"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('aiSearchPrincipalId'), variables('roleDefinitions').cognitiveServicesOpenAIUser)]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').cognitiveServicesOpenAIUser)]",
                "principalId": "[parameters('aiSearchPrincipalId')]"
              }
            },
            {
              "copy": {
                "name": "userContributorRole",
                "count": "[length(parameters('userIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('userIds')[copyIndex()], 'Contributor')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').userGroupContributor)]",
                "principalId": "[parameters('userIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "aiSearchServiceContributorRole",
                "count": "[length(parameters('userIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('userIds')[copyIndex()], 'SearchServiceContributor')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').searchServiceContributor)]",
                "principalId": "[parameters('userIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "aiSearchIndexDataContributorRole",
                "count": "[length(parameters('userIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('userIds')[copyIndex()], 'SearchIndexDataContributor')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').searchIndexDataContributor)]",
                "principalId": "[parameters('userIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "aiSearchIndexDataReaderRole",
                "count": "[length(parameters('userIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('userIds')[copyIndex()], 'SearchIndexDataReader')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').searchIndexDataReader)]",
                "principalId": "[parameters('userIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "storageBlobDataReaderRole",
                "count": "[length(parameters('userIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('userIds')[copyIndex()], 'StorageBlobDataReader')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').storageBlobDataReader)]",
                "principalId": "[parameters('userIds')[copyIndex()]]"
              }
            }
          ],
          "outputs": {
            "storageBlobDataReaderAISearchRoleId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, parameters('aiSearchPrincipalId'), 'StorageBlobDataReader'))]"
            },
            "cognitiveServicesOpenAIUserAISearchRoleId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, parameters('aiSearchPrincipalId'), variables('roleDefinitions').cognitiveServicesOpenAIUser))]"
            },
            "userContributorRoleIds": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('userIds'))]",
                "input": "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, parameters('userIds')[copyIndex()], 'Contributor'))]"
              }
            },
            "aiSearchServiceContributorRoleIds": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('userIds'))]",
                "input": "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, parameters('userIds')[copyIndex()], 'SearchServiceContributor'))]"
              }
            },
            "aiSearchIndexDataContributorRoleIds": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('userIds'))]",
                "input": "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, parameters('userIds')[copyIndex()], 'SearchIndexDataContributor'))]"
              }
            },
            "aiSearchIndexDataReaderRoleIds": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('userIds'))]",
                "input": "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, parameters('userIds')[copyIndex()], 'SearchIndexDataReader'))]"
              }
            },
            "storageBlobDataReaderRoleIds": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('userIds'))]",
                "input": "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, parameters('userIds')[copyIndex()], 'StorageBlobDataReader'))]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'aiFoundryModule')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'aiSearchModule')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'openAIModule')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'storageModule')]"
      ]
    }
  ]
}